<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>코스닥 신규상장 - VC 매매금액 분석</title>
    <!--
        데이터 출처: DART 대량보유상황보고서 (dart.fss.or.kr)
        VC 식별: VC_선별_워크플로우.md 참조
        분석 대상:
          - 신규상장 시점 보유 VC (보통주/CB/BW 등 전체)의
          - 이후 보통주(의결권있는 주식) 매매만 포함
          - 장내매매, 장외매매, 시간외매매
          - 거래금액 = 단가(HLD_UNT_PR) × 변동수량(MDF_SDK_CNT)
    -->
    <script src="https://cdn.plot.ly/plotly-2.35.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', -apple-system, sans-serif; background: #0f1117; color: #e0e0e0; }
        .header { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 28px 40px; border-bottom: 1px solid #2a2a4a; }
        .header h1 { font-size: 24px; font-weight: 600; color: #fff; }
        .header p { font-size: 14px; color: #888; margin-top: 5px; }
        .header .note { font-size: 11px; color: #666; margin-top: 10px; line-height: 1.6; border-top: 1px solid #2a2a4a; padding-top: 10px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; padding: 18px 40px; }
        .summary-card { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 10px; padding: 14px 16px; }
        .summary-card .label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: .5px; }
        .summary-card .value { font-size: 20px; font-weight: 700; margin-top: 3px; }
        .summary-card .sub { font-size: 11px; color: #666; margin-top: 2px; }
        .positive { color: #ef4444; } .negative { color: #3b82f6; } .neutral { color: #fff; }
        .chart-container { padding: 10px 40px; }
        .chart-box { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 10px; padding: 20px; margin-bottom: 14px; }
        .chart-title { font-size: 16px; font-weight: 600; margin-bottom: 3px; color: #fff; }
        .chart-subtitle { font-size: 12px; color: #888; margin-bottom: 10px; }
        .tab-bar { display: flex; gap: 4px; padding: 10px 40px 0; }
        .tab { padding: 10px 20px; background: #1a1d29; border: 1px solid #2a2d3a; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 13px; color: #888; transition: all .15s; }
        .tab:hover { color: #ccc; } .tab.active { color: #fff; border-color: #3b82f6; }
        table.ranking { width: 100%; border-collapse: collapse; font-size: 13px; }
        table.ranking th { text-align: left; padding: 8px 10px; color: #888; border-bottom: 1px solid #2a2d3a; font-weight: 500; font-size: 11px; }
        table.ranking td { padding: 6px 10px; border-bottom: 1px solid #1f2230; }
        table.ranking tr:hover { background: #1f2233; }
        .bar-cell { display: flex; align-items: center; gap: 6px; }
        .bar-fill { height: 6px; border-radius: 3px; min-width: 2px; }
        /* ── VC 확인기준 탭 ── */
        .doc { padding: 24px 32px; line-height: 1.8; font-size: 14px; color: #d0d0d0; }
        .doc h2 { font-size: 18px; font-weight: 700; color: #fff; margin: 28px 0 12px; padding-bottom: 6px; border-bottom: 1px solid #2a2d3a; }
        .doc h2:first-child { margin-top: 0; }
        .doc h3 { font-size: 15px; font-weight: 600; color: #e0e0e0; margin: 20px 0 8px; }
        .doc p { margin: 6px 0; }
        .doc blockquote { border-left: 3px solid #3b82f6; padding: 8px 16px; margin: 10px 0; background: rgba(59,130,246,0.08); border-radius: 0 6px 6px 0; color: #93c5fd; font-weight: 500; }
        .doc ul, .doc ol { margin: 6px 0 6px 20px; }
        .doc li { margin: 3px 0; }
        .doc table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
        .doc th { text-align: left; padding: 8px 12px; background: #1f2233; color: #93c5fd; border-bottom: 2px solid #2a2d3a; font-weight: 600; font-size: 12px; white-space: nowrap; }
        .doc td { padding: 6px 12px; border-bottom: 1px solid #1f2230; vertical-align: top; }
        .doc tr:hover { background: #1a1d2a; }
        .doc .tag-include { display: inline-block; padding: 1px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(239,68,68,0.15); color: #ef4444; }
        .doc .tag-exclude { display: inline-block; padding: 1px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background: rgba(59,130,246,0.15); color: #60a5fa; }
        .doc .tag-keyword { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 4px; font-size: 12px; background: #1f2233; color: #a78bfa; border: 1px solid #3a3d4a; font-family: monospace; }
        .doc .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin: 12px 0; }
        .doc .stat-item { background: #1a1d29; border: 1px solid #2a2d3a; border-radius: 8px; padding: 12px 16px; text-align: center; }
        .doc .stat-item .num { font-size: 22px; font-weight: 700; color: #fff; }
        .doc .stat-item .desc { font-size: 11px; color: #888; margin-top: 2px; }
        .doc .case-box { background: #14161e; border: 1px solid #2a2d3a; border-radius: 8px; padding: 14px 18px; margin: 10px 0; }
        .doc .case-box .case-title { font-size: 13px; font-weight: 600; color: #f59e0b; margin-bottom: 6px; }
        .doc .case-box ul { margin: 4px 0 4px 16px; }
        /* ── 가로 퍼널 다이어그램 ── */
        .hfunnel { display: flex; align-items: stretch; gap: 0; margin: 20px 0; overflow-x: auto; padding-bottom: 4px; }
        .hfunnel-step { display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 130px; position: relative; }
        .hfunnel-bar { width: 100%; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 14px 8px; transition: all .2s; position: relative; }
        .hfunnel-num { font-size: 22px; font-weight: 800; color: #fff; }
        .hfunnel-unit { font-size: 11px; color: rgba(255,255,255,.7); margin-top: 1px; }
        .hfunnel-label { font-size: 13px; color: #e0e0e0; text-align: center; margin-top: 10px; line-height: 1.4; font-weight: 700; }
        .hfunnel-desc { font-size: 12px; color: #888; text-align: center; margin-top: 5px; line-height: 1.5; }
        .hfunnel-pct { font-size: 10px; color: rgba(255,255,255,.5); margin-top: 2px; }
        .hfunnel-arrow { display: flex; align-items: center; justify-content: center; width: 28px; min-width: 28px; color: #3a3d4a; font-size: 16px; align-self: flex-start; margin-top: 28px; }
        .hfunnel-arrow span { display: block; width: 20px; height: 2px; background: #3a3d4a; position: relative; }
        .hfunnel-arrow span::after { content:''; position: absolute; right: -1px; top: -4px; border: 5px solid transparent; border-left: 6px solid #3a3d4a; }
    </style>
</head>
<body>
    <div class="header">
        <h1>코스닥 신규상장 종목 - VC 매매금액 분석</h1>
        <p>신규상장 시점 보유 VC의 상장 후 보통주 매매 <b>거래대금</b> 분석 (단가 &times; 수량)</p>
        <div class="note">
            데이터: DART 대량보유상황보고서 &nbsp;|&nbsp;
            대상: 신규상장 시점 보유 VC 675사 &rarr; 이후 보통주(의결권있는 주식) 매매 &nbsp;|&nbsp;
            분석 대상: <b>장내매매, 장외매매, 시간외매매</b>만 포함 &nbsp;|&nbsp;
            금액 = HLD_UNT_PR &times; MDF_SDK_CNT
        </div>
    </div>

    <div class="summary-grid" id="summaryGrid"></div>

    <div class="tab-bar" id="tabBar">
        <div class="tab active" data-tab="net">순매매금액</div>
        <div class="tab" data-tab="type">매매유형별</div>
        <div class="tab" data-tab="corp">종목 랭킹</div>
        <div class="tab" data-tab="vc">VC 랭킹</div>
        <div class="tab" data-tab="early">6개월 내 매도</div>
        <div class="tab" data-tab="yearly">연도별 비교</div>
        <div class="tab" data-tab="criteria">VC 확인기준</div>
        <div class="tab" data-tab="notes">참고사항</div>
    </div>

    <!-- 탭1: 순매매금액 -->
    <div id="tab-net" class="chart-container">
        <div class="chart-box">
            <div class="chart-title">경과일별 VC 순매매금액 (30일 단위)</div>
            <div class="chart-subtitle">상장일 기준 경과일 구간별 순매매금액 합계 (전 종목 합산). 점선 = 보호예수 해제 기준일</div>
            <div id="chartNetBar" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">누적 순매매금액 추이</div>
            <div class="chart-subtitle">경과일에 따른 VC의 누적 순매매금액 변화</div>
            <div id="chartCumulative" style="height:360px;"></div>
        </div>
        <div class="chart-box">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:3px;">
                <div class="chart-title" style="margin:0">IPO 대비 순매매 비율 (30일 단위)</div>
                <select id="pctBarBase" style="padding:4px 8px;background:#14161e;border:1px solid #2a2d3a;border-radius:4px;color:#e0e0e0;font-size:12px;">
                    <option value="offering" selected>공모금액</option>
                    <option value="mcap">공모가 기준 시총</option>
                </select>
            </div>
            <div class="chart-subtitle">경과일 구간별 순매매금액이 전 종목 합산 기준 총액의 몇 %인지 표시. 점선 = 보호예수 해제 기준일</div>
            <div id="chartPctBar" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:3px;">
                <div class="chart-title" style="margin:0">IPO 대비 누적 순매매 비율</div>
                <select id="pctCumBase" style="padding:4px 8px;background:#14161e;border:1px solid #2a2d3a;border-radius:4px;color:#e0e0e0;font-size:12px;">
                    <option value="offering" selected>공모금액</option>
                    <option value="mcap">공모가 기준 시총</option>
                </select>
            </div>
            <div class="chart-subtitle">경과일에 따른 VC 누적 순매매금액의 기준 총액 대비 비율(%)</div>
            <div id="chartPctCum" style="height:360px;"></div>
        </div>
    </div>

    <!-- 탭2: 매매유형별 -->
    <div id="tab-type" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="chart-title">매매유형별 총 거래대금</div>
            <div id="chartTypeBar" style="height:340px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">매매유형별 경과일 추이 (금액)</div>
            <div class="chart-subtitle">범례 클릭으로 개별 유형 토글</div>
            <div id="chartTypeTime" style="height:400px;"></div>
        </div>
    </div>

    <!-- 탭3: 종목 랭킹 -->
    <div id="tab-corp" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="chart-title">순매도금액 상위 종목 TOP 30 (VC 엑시트 규모)</div>
            <div class="chart-subtitle">상장일 ~ +24개월(720일) 기간 집계</div>
            <div id="tableSell"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">순매수금액 상위 종목 TOP 30</div>
            <div class="chart-subtitle">상장일 ~ +24개월(720일) 기간 집계</div>
            <div id="tableBuy"></div>
        </div>
    </div>

    <!-- 탭4: VC 랭킹 -->
    <div id="tab-vc" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="chart-title">순매도금액 상위 VC TOP 30</div>
            <div class="chart-subtitle">가장 많이 매도한 VC(주주) - 금액 기준 | 상장일 ~ +24개월(720일) 기간 집계</div>
            <div id="tableVCSell"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">순매수금액 상위 VC TOP 30</div>
            <div class="chart-subtitle">가장 많이 매수한 VC(주주) - 금액 기준 | 상장일 ~ +24개월(720일) 기간 집계</div>
            <div id="tableVCBuy"></div>
        </div>
    </div>

    <!-- 탭: 조기매도 (6개월 이내) -->
    <div id="tab-early" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="chart-title">상장 후 6개월 이내 순매도금액 상위 종목 TOP 30</div>
            <div class="chart-subtitle">상장일 ~ +180일 이내 VC 매매만 집계. 클릭하면 개별 공시내역 펼침</div>
            <div id="tableEarlySell"></div>
        </div>
    </div>

    <!-- 탭: 연도별 비교 -->
    <div id="tab-yearly" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="chart-title">연도별 VC 매매 요약</div>
            <div id="tableYearlySummary"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">상장연도별 VC 순매도금액 (전체 24개월)</div>
            <div class="chart-subtitle">IPO 상장연도 기준, 상장 후 24개월(720일) 이내 VC 순매매금액 합계</div>
            <div id="chartYearlyFullBar" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">상장연도별 공모금액 대비 순매도 비율 (전체 24개월)</div>
            <div class="chart-subtitle">해당 연도 IPO 총 공모금액 대비 24개월 이내 순매도금액 비율 (%)</div>
            <div id="chartYearlyFullPct" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">상장연도별 6개월 이내 VC 순매도금액</div>
            <div class="chart-subtitle">IPO 상장연도 기준, 상장 후 180일 이내 VC 순매매금액 합계</div>
            <div id="chartYearlyBar" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">상장연도별 공모금액 대비 6개월 이내 매도 비율</div>
            <div class="chart-subtitle">해당 연도 IPO 총 공모금액 대비 6개월 이내 순매도금액 비율 (%). IPO 규모 차이를 보정한 비교</div>
            <div id="chartYearlyPct" style="height:420px;"></div>
        </div>
        <div class="chart-box">
            <div class="chart-title">연도별 30일 단위 매도 타이밍 비교</div>
            <div class="chart-subtitle">6개월 이내에서 언제 집중적으로 매도하는지 연도별 패턴 비교 (30일 단위)</div>
            <div id="chartYearlyBin" style="height:420px;"></div>
        </div>
    </div>

    <!-- 탭5: VC 확인기준 -->
    <div id="tab-criteria" class="chart-container" style="display:none;">

        <!-- 5-1. 분석 데이터 구조 (파이프라인) -->
        <div class="chart-box">
            <div class="doc">
                <h2>분석 데이터 구조</h2>
                <p>코스닥 신규상장 종목이 분석 대상에 포함되기까지의 필터링 과정입니다.</p>

                <div class="hfunnel" id="hfunnelDiagram"></div>

                <div class="case-box" style="margin-top:16px">
                    <div class="case-title">왜 Phase A에서는 주식 종류를 가리지 않는가?</div>
                    <ul>
                        <li>VC는 상장 전 CB/BW/RCPS 등 다양한 수단으로 투자합니다. 보통주만으로 필터하면 CB/BW로만 투자한 VC가 누락됩니다.</li>
                        <li>따라서 <b>신규상장 시점 보유 여부</b>는 주식 종류 불문으로 판단하고, <b>이후 매매 분석</b>에서만 보통주로 한정합니다.</li>
                        <li>이렇게 하면 "CB로 투자 &rarr; 상장 후 보통주 전환 &rarr; 보통주 매도" 패턴도 빠짐없이 포착됩니다.</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 5-2. VC 판별 개요 + 통계 -->
        <div class="chart-box">
            <div class="doc">
                <h2>VC는 어떻게 판별했는가?</h2>
                <p>코스닥 신규상장 종목의 대량보유상황보고에 등장하는 법인/펀드 주주 <b>1,325사</b>를 전수 점검하여 VC 여부를 판별한 과정입니다.<br>
                <span style="color:#888;font-size:12px">위 퍼널의 "대량보유 보고 존재" 단계에서 개인을 제외한 법인/펀드만 추출한 수치입니다.</span></p>
                <div class="stat-grid" id="selStatGrid"></div>

                <h3 style="margin-top:24px">핵심 원칙</h3>
                <blockquote>본업이 벤처/스타트업 투자인지가 유일한 핵심 기준이다.</blockquote>
                <ol>
                    <li>VCS(벤처투자종합포털) 등록, KVCA 회원 등 <b>공식 목록 매칭을 우선</b> 참조하되, 등록만으로 자동 포함하지 않음 (증권사가 신기술사로 등록된 경우 등)</li>
                    <li>키워드 매칭은 <b>후보 추출용</b>이며, 최종 판단은 실체 확인 후 결정</li>
                    <li>법적 라이선스(신기술사 등)가 있더라도 <b>부수적 업무이면 제외</b></li>
                </ol>
            </div>
        </div>

        <!-- 5-3. 선별 프로세스 -->
        <div class="chart-box">
            <div class="doc">
                <h2>선별 프로세스 (6단계)</h2>

                <h3>Step 1. 분석대상 추출</h3>
                <p>원본 데이터에서 개인(주민번호) 제외, 법인/펀드만 추출 &rarr; <b>1,581행 (1,325 고유 사업자번호)</b></p>

                <h3>Step 2. Phase 1: 참조 데이터 직접 매칭 (6단계)</h3>
                <table>
                    <thead><tr><th>Phase</th><th>방법</th><th>참조 데이터</th><th>출처</th></tr></thead>
                    <tbody>
                        <tr><td><b>1A</b></td><td>KVCA 조합명 exact match</td><td>kvca_조합현황.csv (2,401건)</td>
                            <td><a href="http://diva.kvca.or.kr/div/dii/DivItmAssoInq" target="_blank" rel="noopener" style="color:#60a5fa">KVCA DIVA</a><br><span style="font-size:11px;color:#666">한국벤처캐피탈협회 조합정보시스템</span></td></tr>
                        <tr><td><b>1B</b></td><td>VCS 등록 벤처투자회사명 match</td><td>등록_벤처투자회사_목록.csv (726건)</td>
                            <td><a href="https://www.vcs.go.kr/web/portal/investor/list" target="_blank" rel="noopener" style="color:#60a5fa">VCS</a><br><span style="font-size:11px;color:#666">벤처투자종합포털 등록 벤처투자회사</span></td></tr>
                        <tr><td><b>1C</b></td><td>KVCA 회원사명 match</td><td>kvca_회원사_목록.csv (213건)</td>
                            <td><a href="https://www.kvca.or.kr/Program/membership/list.html?a_gb=member&a_cd=2&a_item=0&sm=5_3_1" target="_blank" rel="noopener" style="color:#60a5fa">KVCA</a><br><span style="font-size:11px;color:#666">한국벤처캐피탈협회 회원사 목록</span></td></tr>
                        <tr><td><b>1D</b></td><td>모태펀드 운용사명 match</td><td>모태펀드 자조합 운용사정보.csv (1,411건)</td>
                            <td><a href="https://www.data.go.kr" target="_blank" rel="noopener" style="color:#60a5fa">data.go.kr</a><br><span style="font-size:11px;color:#666">공공데이터포털 &mdash; 한국벤처투자 모태펀드 자조합 운용사정보</span></td></tr>
                        <tr><td><b>1E</b></td><td>GP명이 SPC_NM에 부분포함 (4자 이상)</td><td>위 GP명 통합</td>
                            <td><span style="font-size:11px;color:#666">1A~1D에서 추출된 GP명 활용</span></td></tr>
                        <tr><td><b>1F</b></td><td>창업벤처전문 PEF명 부분매칭</td><td>창업벤처전문_PEF.xlsx (151건)</td>
                            <td><a href="https://www.fss.or.kr/fss/bbs/B0000079/list.do?menuNo=200111" target="_blank" rel="noopener" style="color:#60a5fa">금융감독원</a><br><span style="font-size:11px;color:#666">사모펀드 공시 &mdash; 창업벤처전문 PEF 목록</span></td></tr>
                    </tbody>
                </table>
                <p style="font-size:12px;color:#666;margin-top:8px">* 추가 참조: <a href="https://www.data.go.kr" target="_blank" rel="noopener" style="color:#60a5fa">data.go.kr</a> &mdash; 신기술금융사 일반현황 (신기술사업금융업 등록 여부 확인용)</p>

                <h3>Step 3. Phase 2: 사업자등록번호 역매칭</h3>
                <p>Phase 1에서 확인된 VC의 사업자번호(SPC_ID2)로 미매칭 행을 추가 포착. 동일 사업자번호 = 같은 GP 산하 다른 펀드/조합.</p>

                <h3>Step 4. Phase 3~4: 키워드 후보 + 제외 규칙</h3>
                <p><b>Phase 3</b>: VC 관련 키워드(<code>투자조합, 벤처투자, 인베스트먼트, 캐피탈, 파트너스, 펀드</code> 등)로 후보 추출.</p>
                <p><b>Phase 4</b>: 제외 규칙 적용 &mdash; 증권사, 자산운용사, 여신전문금융 캐피탈, 구조조정/M&A/메자닌 전문 펀드, 일반 PEF 등을 제외.</p>

                <h3>Step 5. Phase 5: 자동분류 + 웹서치 검증</h3>
                <ul>
                    <li><b>5-A 자동포함</b>: "투자조합", "벤처투자", "창업투자" 등 VC 확실 패턴</li>
                    <li><b>5-B 영문명 전수 제외</b>: 해외법인 직접 투자분 (한국 VC업계 분석 목적)</li>
                    <li><b>5-C 웹서치 검증</b>: 나머지 후보 82건을 개별 검색하여 실체 확인</li>
                </ul>

                <h3>Step 6. 최종 병합 + 대량보유 데이터 필터링</h3>
                <p>전 단계 결과를 병합하고 중복 제거(제외가 포함보다 우선) &rarr; VC 710사 확정 &rarr; 원본 대량보유 데이터에서 VC 주주만 추출.</p>
            </div>
        </div>

        <!-- 5-4. Phase별 선별 통계 차트 -->
        <div class="chart-box">
            <div class="doc">
                <h2>Phase별 선별 결과</h2>
                <div id="chartPhaseBar" style="height:320px;"></div>
            </div>
        </div>

        <!-- 5-5. 포함/제외 기준 상세 -->
        <div class="chart-box">
            <div class="doc">
                <h2>포함 대상 <span class="tag-include">INCLUDE</span></h2>
                <table>
                    <thead><tr><th>유형</th><th>설명</th><th>예시</th></tr></thead>
                    <tbody>
                        <tr><td>벤처투자회사(창투사)</td><td>벤처투자 촉진에 관한 법률 등록</td><td>한국투자파트너스, 스톤브릿지벤처스</td></tr>
                        <tr><td>신기술사업금융업자</td><td>벤처투자가 <b>본업</b>인 신기술금융사</td><td>에스티캐피탈, 무림캐피탈</td></tr>
                        <tr><td>투자조합/벤처펀드</td><td>VC가 GP로 운용하는 투자조합/펀드</td><td>스톤브릿지2020벤처투자조합</td></tr>
                        <tr><td>CVC(기업형 VC)</td><td>대기업 전담 벤처투자 자회사</td><td>펄어비스캐피탈, 롯데벤처스</td></tr>
                        <tr><td>액셀러레이터</td><td>초기 스타트업 투자/보육</td><td>빅뱅벤처스, 제로원액셀러레이터</td></tr>
                        <tr><td>창업벤처전문 PEF</td><td>"창업벤처전문" 등록 사모투자합자회사</td><td>유암코헬리오스중소기업성장창업벤처전문PEF</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="chart-box">
            <div class="doc">
                <h2>제외 대상 <span class="tag-exclude">EXCLUDE</span></h2>
                <table>
                    <thead><tr><th>유형</th><th>판단 근거</th><th>예시</th></tr></thead>
                    <tbody>
                        <tr><td><b>증권사</b></td><td>IPO 주관/인수/중개가 본업. 신기술사 등록도 부수적</td><td>미래에셋증권, NH투자증권, 한화투자증권</td></tr>
                        <tr><td><b>자산운용사</b></td><td>공모펀드/ETF/헤지펀드 운용이 본업</td><td>미래에셋자산운용, 키움투자자산운용</td></tr>
                        <tr><td><b>캐피탈사(여신전문금융)</b></td><td>리스/대출/할부금융이 본업</td><td>키움캐피탈, 메리츠캐피탈, 산은캐피탈</td></tr>
                        <tr><td><b>투자자문/투자일임</b></td><td>공모주/메자닌/상장주식 자문이 본업</td><td>마블투자자문, 브라이트투자자문</td></tr>
                        <tr><td><b>구조조정 펀드</b></td><td>"기업재무안정"/"턴어라운드"/"크레딧" 목적</td><td>유진신영기업구조혁신PEF</td></tr>
                        <tr><td><b>일반 PEF</b></td><td>창업벤처전문 미등록 사모투자합자회사</td><td>린드먼아시아글로벌파이오니어PEF</td></tr>
                        <tr><td><b>메자닌 전문</b></td><td>벤처투자가 아닌 메자닌 전문 펀드/투자조합</td><td>한양타임메자닌신기술투자조합</td></tr>
                        <tr><td><b>해외법인</b></td><td>한국 VC업계 분석 목적이므로 해외 본체 제외</td><td>Kayne Anderson, Virtus KAR</td></tr>
                        <tr><td><b>M&A 전문 PE</b></td><td>M&A/바이아웃 전문</td><td>코메스2018-1M&A투자조합</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 5-6. 제외사유별 분포 차트 -->
        <div class="chart-box">
            <div class="doc">
                <h2>제외사유별 분포</h2>
                <div id="chartExReasonBar" style="height:300px;"></div>
            </div>
        </div>

        <!-- 5-7. 경계 사례 -->
        <div class="chart-box">
            <div class="doc">
                <h2>주요 경계 사례</h2>
                <div class="case-box">
                    <div class="case-title">"캐피탈" &mdash; 개별 확인 필수</div>
                    <ul>
                        <li><span class="tag-exclude">제외</span> 여신전문금융 (리스/대출): 산은캐피탈, 신한캐피탈, 하나캐피탈, 메리츠캐피탈, 키움캐피탈</li>
                        <li><span class="tag-include">포함</span> 벤처캐피탈/CVC: 타임폴리오캐피탈, 펄어비스캐피탈, 뉴메인캐피탈, 무림캐피탈, 에스티캐피탈</li>
                    </ul>
                </div>
                <div class="case-box">
                    <div class="case-title">"자산운용" &mdash; 대부분 제외, VCS 등록 VC는 포함</div>
                    <ul>
                        <li><span class="tag-exclude">제외</span> 일반 자산운용사: 미래에셋자산운용, 한국투자밸류자산운용, 제이씨에셋자산운용</li>
                        <li><span class="tag-include">포함</span> VCS 등록 + 벤처투자 활동: 아이온자산운용, 타이거자산운용투자일임</li>
                    </ul>
                </div>
                <div class="case-box">
                    <div class="case-title">PEF &mdash; "창업벤처전문" 등록 여부로 구분</div>
                    <ul>
                        <li><span class="tag-exclude">제외</span> 일반 PEF: 기업재무안정, 턴어라운드, 스페셜시츄에이션 목적</li>
                        <li><span class="tag-include">포함</span> 창업벤처전문 PEF: VC가 GP, 벤처투자 목적 명시</li>
                    </ul>
                </div>
                <div class="case-box">
                    <div class="case-title">GP명 부분매칭 오탐 방지</div>
                    <ul>
                        <li>3글자 이하 GP명은 부분매칭에서 제외</li>
                        <li>역방향 매칭(SPC_NM이 GP명에 포함) 불허 &mdash; 일반 기업명이 VC명에 우연히 포함되는 경우 방지</li>
                        <li>오탐 사례: 스노우 &ne; 스노우볼벤처스, 카카오 &ne; 카카오벤처스, 에코프로 &ne; 에코프로파트너스</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 5-8. VC 목록 (검색 가능한 테이블) -->
        <div class="chart-box">
            <div class="doc">
                <h2>VC 선별결과 목록 (<span id="vcListCount">710</span>사)</h2>
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="vcSearchInput" placeholder="VC명, GP명, Phase로 검색..." style="flex:1;min-width:200px;padding:8px 12px;background:#14161e;border:1px solid #2a2d3a;border-radius:6px;color:#e0e0e0;font-size:13px;">
                    <select id="vcPhaseFilter" style="padding:8px 10px;background:#14161e;border:1px solid #2a2d3a;border-radius:6px;color:#e0e0e0;font-size:13px;">
                        <option value="">전체 Phase</option>
                    </select>
                    <select id="vcTypeFilter" style="padding:8px 10px;background:#14161e;border:1px solid #2a2d3a;border-radius:6px;color:#e0e0e0;font-size:13px;">
                        <option value="">전체 유형</option>
                        <option value="GP(운용사)">GP(운용사)</option>
                        <option value="펀드/조합">펀드/조합</option>
                    </select>
                    <span id="vcFilterCount" style="font-size:12px;color:#888;"></span>
                </div>
                <div id="vcListTable" style="max-height:500px;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- 5-9. 제외 목록 -->
        <div class="chart-box">
            <div class="doc">
                <h2>제외 목록 (<span id="exListCount">107</span>사)</h2>
                <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;align-items:center;">
                    <input type="text" id="exSearchInput" placeholder="이름, 제외사유로 검색..." style="flex:1;min-width:200px;padding:8px 12px;background:#14161e;border:1px solid #2a2d3a;border-radius:6px;color:#e0e0e0;font-size:13px;">
                    <select id="exReasonFilter" style="padding:8px 10px;background:#14161e;border:1px solid #2a2d3a;border-radius:6px;color:#e0e0e0;font-size:13px;">
                        <option value="">전체 사유</option>
                    </select>
                    <span id="exFilterCount" style="font-size:12px;color:#888;"></span>
                </div>
                <div id="exListTable" style="max-height:400px;overflow-y:auto;"></div>
            </div>
        </div>

        <!-- 5-10. 미확인 -->
        <div class="chart-box">
            <div class="doc">
                <h2>수동확인 필요 (<span id="unkListCount">6</span>건)</h2>
                <p style="font-size:12px;color:#888;margin-bottom:10px;">웹서치로도 VC 여부를 확인할 수 없는 항목. 보수적으로 분석에서 제외.</p>
                <div id="unkListTable"></div>
            </div>
        </div>

    </div>

    <!-- 탭: 참고사항 (비보통주 상세) -->
    <div id="tab-notes" class="chart-container" style="display:none;">
        <div class="chart-box">
            <div class="doc">
                <h2>Phase A 비보통주 보유 상세</h2>
                <p>신규상장 시점(Phase A) 236개 종목 중 <b>보통주(의결권있는 주식) 외</b>의 주식종류를 보유한 VC 현황입니다.</p>
                <p style="font-size:12px;color:#888;margin-top:4px">
                    Phase A에서는 VC 식별 목적으로 주식종류를 가리지 않으므로, CB/BW/DR 등 비보통주 보유자도 포함됩니다.
                    이후 Phase B(매매 분석)에서는 보통주 매매만 집계합니다.
                </p>

                <div class="stat-grid" style="margin:16px 0;">
                    <div class="stat-item"><div class="num" id="ncTotalRecords">30</div><div class="desc">비보통주 레코드</div></div>
                    <div class="stat-item"><div class="num" id="ncTotalCorps">18</div><div class="desc">해당 종목</div></div>
                    <div class="stat-item"><div class="num" id="ncDualCount">-</div><div class="desc">보통주 동시보유</div></div>
                    <div class="stat-item"><div class="num" id="ncOnlyCount">-</div><div class="desc">비보통주만 보유</div></div>
                </div>

                <h3 style="margin-top:20px">주식종류별 분포</h3>
                <div id="chartNcTypeDist" style="height:260px;"></div>
            </div>
        </div>
        <div class="chart-box">
            <div class="doc">
                <h2>종목별 비보통주 보유 상세</h2>
                <p style="font-size:12px;color:#888;">각 종목을 클릭하면 상세 내역이 펼쳐집니다. DART 접수번호를 클릭하면 원본 공시로 이동합니다.</p>
                <div id="ncCorpList"></div>
            </div>
        </div>
    </div>

<script>
let DATA = null, SEL = null;
Promise.all([
    fetch('vc_analysis_amt.json?t='+Date.now()).then(r=>{if(!r.ok)throw new Error('amt.json: '+r.status);return r.json();}),
    fetch('vc_selection_data.json?t='+Date.now()).then(r=>{if(!r.ok)throw new Error('selection.json: '+r.status);return r.json();})
]).then(([d,s])=>{DATA=d;SEL=s;init();}).catch(e=>document.body.innerHTML='<h2 style="color:red;padding:40px">JSON 로드 실패: '+e.message+'</h2>');

function init(){
    renderSummary();
    renderNetBar();
    renderCumulative();
    renderPctBar('offering');
    renderPctCumulative('offering');

    document.getElementById('pctBarBase').addEventListener('change',function(){renderPctBar(this.value);});
    document.getElementById('pctCumBase').addEventListener('change',function(){renderPctCumulative(this.value);});

    initTabs();
}

/* ── Util ── */
function fmtAmt(n){
    const a=Math.abs(n),s=n<0?'-':'';
    if(a>=1e12)return s+(a/1e12).toFixed(1)+'조';
    if(a>=1e8)return s+(a/1e8).toFixed(0)+'억';
    if(a>=1e4)return s+Math.round(a/1e4)+'만';
    return n.toLocaleString();
}
function fmtAmtDetail(n){
    const a=Math.abs(n),s=n<0?'-':'';
    if(a>=1e12){const t=Math.floor(a/1e12),b=Math.round((a%1e12)/1e8);return s+t+'조 '+b.toLocaleString()+'억';}
    if(a>=1e8)return s+(a/1e8).toFixed(0)+'억';
    if(a>=1e4)return s+Math.round(a/1e4)+'만';
    return n.toLocaleString()+'원';
}
function fmtShares(n){
    const a=Math.abs(n),s=n<0?'-':'';
    if(a>=1e8)return s+(a/1e8).toFixed(1)+'억주';
    if(a>=1e4)return s+Math.round(a/1e4)+'만주';
    return n.toLocaleString()+'주';
}

function fmtAxisKRW(n){
    const a=Math.abs(n),s=n<0?'-':'';
    if(a>=1e12)return s+(a/1e12).toFixed(1)+'조';
    if(a>=1e8)return s+(a/1e8).toFixed(0)+'억';
    if(a>=1e4)return s+Math.round(a/1e4)+'만';
    if(a===0)return '0';
    return n.toLocaleString();
}
function krwYAxis(values,title){
    const mn=Math.min(...values),mx=Math.max(...values);
    const range=mx-mn||1;
    const step=(() => {
        const raw=range/6;
        const mag=Math.pow(10,Math.floor(Math.log10(raw)));
        const nice=[1,2,5,10].find(m=>m*mag>=raw)*mag;
        return nice;
    })();
    const start=Math.floor(mn/step)*step, end=Math.ceil(mx/step)*step;
    const tvals=[];
    for(let v=start;v<=end+step/2;v+=step) tvals.push(v);
    return {gridcolor:'#2a2d3a',zerolinecolor:'#3a3d4a',title:title,tickvals:tvals,ticktext:tvals.map(fmtAxisKRW)};
}

const TYPE_COLORS={'장내매도':'#3b82f6','장내매수':'#ef4444','장외매도':'#60a5fa','장외매수':'#f87171','시간외매매':'#a78bfa'};

const DARK={
    paper_bgcolor:'rgba(0,0,0,0)',plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:'#ccc',size:12},
    xaxis:{gridcolor:'#2a2d3a',zerolinecolor:'#3a3d4a'},
    yaxis:{gridcolor:'#2a2d3a',zerolinecolor:'#3a3d4a'},
    margin:{l:90,r:30,t:20,b:50},
    hoverlabel:{bgcolor:'#1a1d29',font:{color:'#fff'}},
};

/* 보호예수 해제 기준선 */
const VLINES = [
    {day:180, label:'6개월', color:'#f59e0b'},
    {day:365, label:'1년', color:'#22c55e'},
    {day:540, label:'18개월', color:'#ec4899'},
    {day:730, label:'2년', color:'#8b5cf6'},
];

function addVLines(layout) {
    layout.shapes = VLINES.map(v => ({
        type:'line', x0:v.day, x1:v.day, y0:0, y1:1, yref:'paper',
        line:{color:v.color, width:1.5, dash:'dot'},
    }));
    layout.annotations = VLINES.map(v => ({
        x:v.day, y:1.02, yref:'paper', text:v.label,
        showarrow:false, font:{size:10,color:v.color}, xanchor:'center',
    }));
    return layout;
}

/* ── Summary ── */
function renderSummary(){
    const s=DATA.summary;
    const pctM=v=>s.total_ipo_mcap?(v/s.total_ipo_mcap*100).toFixed(2):'0';
    const pctO=v=>s.total_ipo_offering?(v/s.total_ipo_offering*100).toFixed(2):'0';
    const pctSub=v=>'<br><span style="color:#f59e0b">공모금액의 '+pctO(v)+'%</span> / <span style="color:#a78bfa">공모가기준 시총의 '+pctM(v)+'%</span>';
    const cards=[
        {l:'분석 종목',v:s.total_stocks+'개',c:'neutral',sub:'신규상장 시점 VC '+s.ipo_vc_count+'사'},
        {l:'매매 VC',v:s.total_vcs+'사',c:'neutral',sub:s.total_records.toLocaleString()+'건'},
        {l:'매수 금액',v:fmtAmt(s.buy_amount)+'원',c:'positive',sub:s.buy_count.toLocaleString()+'건 / '+fmtShares(s.buy_shares)+pctSub(s.buy_amount)},
        {l:'매도 금액',v:fmtAmt(s.sell_amount)+'원',c:'negative',sub:s.sell_count.toLocaleString()+'건 / '+fmtShares(s.sell_shares)+pctSub(s.sell_amount)},
        {l:'순매매금액',v:fmtAmtDetail(s.total_net_amount)+'원',c:s.total_net_amount>=0?'positive':'negative',sub:fmtShares(s.total_net_shares)+pctSub(s.total_net_amount)},
    ];
    document.getElementById('summaryGrid').innerHTML=cards.map(c=>
        `<div class="summary-card"><div class="label">${c.l}</div><div class="value ${c.c}">${c.v}</div>${c.sub?'<div class="sub">'+c.sub+'</div>':''}</div>`
    ).join('');

}

/* ── 탭1 ── */
function renderNetBar(){
    const d=DATA.total_bin;
    const yvals=d.map(r=>r.net);
    const layout=addVLines({...DARK, xaxis:{...DARK.xaxis,title:'상장 후 경과일',dtick:60}, yaxis:krwYAxis(yvals,'순매매금액')});
    Plotly.newPlot('chartNetBar',[{
        x:d.map(r=>r.days),y:yvals,type:'bar',
        marker:{color:d.map(r=>r.net>=0?'#ef4444':'#3b82f6')},
        hovertemplate:'경과일 %{x}~%{x}+30일<br>순매매: %{y:,.0f}원<extra></extra>'
    }],layout,{responsive:true});
}

function renderCumulative(){
    const d=DATA.total_bin;
    const yvals=d.map(r=>r.cum);
    const layout=addVLines({...DARK, xaxis:{...DARK.xaxis,title:'상장 후 경과일',dtick:60}, yaxis:krwYAxis(yvals,'누적 순매매금액')});
    Plotly.newPlot('chartCumulative',[{
        x:d.map(r=>r.days),y:yvals,type:'scatter',mode:'lines',
        fill:'tozeroy',line:{color:'#8b5cf6',width:2},fillcolor:'rgba(139,92,246,0.12)',
        hovertemplate:'경과일 %{x}일<br>누적: %{y:,.0f}원<extra></extra>'
    }],layout,{responsive:true});
}

/* ── % 기준 차트 ── */
function renderPctBar(base){
    base=base||'mcap';
    const d=DATA.total_bin;
    const key=base==='mcap'?'net_pct_mcap':'net_pct_offering';
    const label=base==='mcap'?'공모가기준 시총':'공모금액';
    const yvals=d.map(r=>r[key]);
    const layout=addVLines({...DARK,
        xaxis:{...DARK.xaxis,title:'상장 후 경과일',dtick:60},
        yaxis:{...DARK.yaxis,gridcolor:'#2a2d3a',zerolinecolor:'#3a3d4a',title:label+' 대비 %',ticksuffix:'%'}
    });
    Plotly.newPlot('chartPctBar',[{
        x:d.map(r=>r.days),y:yvals,type:'bar',
        marker:{color:d.map(r=>r[key]>=0?'#ef4444':'#3b82f6')},
        hovertemplate:'경과일 %{x}~%{x}+30일<br>순매매: %{y:.2f}%<extra></extra>'
    }],layout,{responsive:true});
}

function renderPctCumulative(base){
    base=base||'mcap';
    const d=DATA.total_bin;
    const key=base==='mcap'?'cum_pct_mcap':'cum_pct_offering';
    const label=base==='mcap'?'공모가기준 시총':'공모금액';
    const yvals=d.map(r=>r[key]);
    const layout=addVLines({...DARK,
        xaxis:{...DARK.xaxis,title:'상장 후 경과일',dtick:60},
        yaxis:{...DARK.yaxis,gridcolor:'#2a2d3a',zerolinecolor:'#3a3d4a',title:'누적 '+label+' 대비 %',ticksuffix:'%'}
    });
    Plotly.newPlot('chartPctCum',[{
        x:d.map(r=>r.days),y:yvals,type:'scatter',mode:'lines',
        fill:'tozeroy',line:{color:'#8b5cf6',width:2},fillcolor:'rgba(139,92,246,0.12)',
        hovertemplate:'경과일 %{x}일<br>누적: %{y:.2f}%<extra></extra>'
    }],layout,{responsive:true});
}

/* ── 탭2 ── */
function renderTypeBar(){
    const d=DATA.type_total;
    const yvals=d.map(r=>r.total_amount);
    Plotly.newPlot('chartTypeBar',[{
        x:d.map(r=>r.type),y:yvals,type:'bar',
        marker:{color:d.map(r=>TYPE_COLORS[r.type]||'#888')},
        text:d.map(r=>fmtAmt(r.total_amount)+'원 ('+r.count+'건)'),textposition:'outside',textfont:{color:'#aaa',size:11},
        hovertemplate:'%{x}<br>%{y:,.0f}원<extra></extra>'
    }],{...DARK,xaxis:{...DARK.xaxis},yaxis:krwYAxis(yvals,'총 거래대금'),margin:{...DARK.margin,b:70}},{responsive:true});
}

function renderTypeTime(){
    const traces=DATA.types.map(t=>{
        const pts=DATA.type_pivot.map(r=>({d:r.days,v:r[t]||0}));
        return{x:pts.map(p=>p.d),y:pts.map(p=>p.v),name:t,type:'scatter',mode:'lines',
            line:{color:TYPE_COLORS[t]||'#888',width:2},hovertemplate:t+'<br>경과일 %{x}일: %{y:,.0f}원<extra></extra>'};
    });
    const allVals=DATA.types.flatMap(t=>DATA.type_pivot.map(r=>r[t]||0));
    const layout=addVLines({...DARK,xaxis:{...DARK.xaxis,title:'상장 후 경과일',dtick:60},yaxis:krwYAxis(allVals,'거래대금'),
        legend:{orientation:'h',y:-0.18,font:{size:11}},margin:{...DARK.margin,b:90}});
    Plotly.newPlot('chartTypeTime',traces,layout,{responsive:true});
}

/* ── 탭3: 종목 랭킹 ── */
function renderCorpRanking(){
    renderCorpTable('tableSell',DATA.corp_top_sell);
    renderCorpTable('tableBuy',DATA.corp_top_buy);
}

function fmtVCs(vcs){
    if(!vcs||!vcs.length)return'-';
    const s=vcs.slice(0,3).join(', ');
    return vcs.length>3?s+' 외 '+(vcs.length-3)+'사':s;
}

function renderCorpTable(id,list){
    const maxAbs=Math.max(...list.map(r=>Math.abs(r.net_amount)));
    let h='<table class="ranking"><thead><tr><th>#</th><th>종목명</th><th>순매매금액</th><th>공모금액대비</th><th>공모가기준 시총대비</th><th>매도금액</th><th>매수금액</th><th>건수</th><th>매도 VC</th><th>매수 VC</th><th></th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        const pct=Math.abs(r.net_amount)/maxAbs*100;
        const color=r.net_amount>=0?'#ef4444':'#3b82f6';
        h+=`<tr><td>${i+1}</td><td><b>${r.corp_name}</b></td>
            <td class="${r.net_amount>=0?'positive':'negative'}">${fmtAmt(r.net_amount)}원</td>
            <td style="color:#f59e0b;font-size:12px">${r.pct_offering!=null?r.pct_offering.toFixed(1)+'%':'-'}</td>
            <td style="color:#a78bfa;font-size:12px">${r.pct_mcap!=null?r.pct_mcap.toFixed(1)+'%':'-'}</td>
            <td style="color:#3b82f6">${fmtAmt(r.sell_amount)}원</td>
            <td style="color:#ef4444">${r.buy_amount?'+'+fmtAmt(r.buy_amount)+'원':'0'}</td>
            <td>${r.tx_count}</td>
            <td style="color:#888;font-size:11px;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(r.sell_vcs||[]).join(', ')}">${fmtVCs(r.sell_vcs)}</td>
            <td style="color:#888;font-size:11px;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${(r.buy_vcs||[]).join(', ')}">${fmtVCs(r.buy_vcs)}</td>
            <td style="width:14%"><div class="bar-cell"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div></td></tr>`;
    });
    h+='</tbody></table>';
    document.getElementById(id).innerHTML=h;
}

/* ── 탭4: VC 랭킹 ── */
function renderVCRanking(){
    renderVCTable('tableVCSell',DATA.vc_top_sell);
    renderVCTable('tableVCBuy',DATA.vc_top_buy);
}

function renderVCTable(id,list){
    const maxAbs=Math.max(...list.map(r=>Math.abs(r.net_amount)));
    let h='<table class="ranking"><thead><tr><th>#</th><th>VC(주주명)</th><th>순매매금액</th><th>매도금액</th><th>매수금액</th><th>건수</th><th>투자종목</th><th></th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        const pct=Math.abs(r.net_amount)/maxAbs*100;
        const color=r.net_amount>=0?'#ef4444':'#3b82f6';
        const corps=r.corps.slice(0,3).join(', ')+(r.corps.length>3?' 외 '+(r.corps.length-3)+'개':'');
        h+=`<tr><td>${i+1}</td><td><b>${r.SPC_NM}</b></td>
            <td class="${r.net_amount>=0?'positive':'negative'}">${fmtAmt(r.net_amount)}원</td>
            <td style="color:#3b82f6">${fmtAmt(r.sell_amount)}원</td>
            <td style="color:#ef4444">${r.buy_amount?'+'+fmtAmt(r.buy_amount)+'원':'0'}</td>
            <td>${r.tx_count}</td>
            <td style="color:#888;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${corps}</td>
            <td style="width:20%"><div class="bar-cell"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div></td></tr>`;
    });
    h+='</tbody></table>';
    document.getElementById(id).innerHTML=h;
}

/* ── 탭5: VC 확인기준 렌더링 ── */
let criteriaRendered = false;

function renderCriteria(){
    if(criteriaRendered || !SEL) return;
    criteriaRendered = true;

    const ss = SEL.summary;

    // 가로 퍼널 다이어그램 렌더링
    const ds = DATA.summary;
    const base = ds.funnel_ipo_total || 1;
    const funnel = [
        {label:'수집대상 (IPO 전체)', count: ds.funnel_ipo_total, color:'#6366f1',
         desc:'2021~2024년 코스닥 신규상장 종목 전체'},
        {label:'대량보유 보고 존재', count: ds.funnel_raw_stocks, color:'#8b5cf6',
         desc:'상장 전후 2.5년 내 대량보유상황보고(5%이상)가 1건 이상 접수된 종목'},
        {label:'VC 포함 종목', count: ds.funnel_vc_stocks, color:'#f59e0b',
         desc:'대량보유 보고 주주 중 VC로 선별된 960사가 1사 이상 포함된 종목'},
        {label:'Phase A (IPO시점 보유)', count: ds.ipo_stock_count, color:'#3b82f6',
         desc:'VC가 신규상장 시점에 지분을 보유(주식종류 불문)하고 있던 종목<br><b>'+ds.ipo_vc_count+'사</b> &times; <b>'+ds.ipo_stock_count+'종목</b>'},
        {label:'Phase B (최종 분석)', count: ds.total_stocks, color:'#22c55e',
         desc:'Phase A의 VC가 보통주를 실제 매매(장내/장외/시간외)한 종목<br><b>'+ds.total_vcs+'사</b>, <b>'+ds.total_records.toLocaleString()+'건</b>'},
    ];
    const maxH = 80, minH = 36;
    document.getElementById('hfunnelDiagram').innerHTML = funnel.map((f,i)=>{
        const pct = (f.count/base*100);
        const h = minH + (maxH-minH)*(f.count/base);
        const arrow = i < funnel.length-1 ? '<div class="hfunnel-arrow"><span></span></div>' : '';
        return `<div class="hfunnel-step">
            <div class="hfunnel-bar" style="background:${f.color};height:${h}px;opacity:${0.6+0.4*(f.count/base)}">
                <div class="hfunnel-num">${f.count.toLocaleString()}</div>
                <div class="hfunnel-pct">${i===0?'':'('+pct.toFixed(1)+'%)'}</div>
            </div>
            <div class="hfunnel-label">${f.label}</div>
            <div class="hfunnel-desc">${f.desc}</div>
        </div>${arrow}`;
    }).join('');

    // 선별 통계 카드
    document.getElementById('selStatGrid').innerHTML = [
        {n: ss.total_candidates.toLocaleString()+'사', d:'분석 대상 (법인/펀드)'},
        {n: '<span style="color:#ef4444">'+ss.vc_count+'사</span>', d:'VC 확정'},
        {n: ss.excluded_count+'사', d:'제외 확정'},
        {n: ss.unknown_count+'건', d:'수동확인 필요'},
        {n: ss.unmatched_count+'사', d:'미매칭 (VC 무관)'},
        {n: ss.vc_gp_count+'사', d:'GP(운용사)'},
        {n: ss.vc_fund_count+'개', d:'펀드/조합'},
    ].map(c=>'<div class="stat-item"><div class="num">'+c.n+'</div><div class="desc">'+c.d+'</div></div>').join('');

    // Phase별 차트
    const ps = SEL.phase_stats;
    Plotly.newPlot('chartPhaseBar',[{
        x: ps.map(p=>p.phase),
        y: ps.map(p=>p.count),
        type:'bar',
        marker:{color: ps.map(p=>p.phase.startsWith('1')?'#3b82f6':p.phase==='2'?'#22c55e':p.phase==='5_auto'?'#f59e0b':'#a78bfa')},
        text: ps.map(p=>p.count+'건'),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate: ps.map(p=>'<b>Phase '+p.phase+'</b><br>'+p.label+'<br>'+p.count+'건<extra></extra>'),
    }],{...DARK,
        xaxis:{...DARK.xaxis,title:'Phase',tickvals:ps.map(p=>p.phase),ticktext:ps.map(p=>p.phase)},
        yaxis:{...DARK.yaxis,title:'건수'},
        margin:{l:60,r:30,t:20,b:60},
    },{responsive:true});

    // 제외사유 차트
    const er = SEL.exclude_reasons;
    Plotly.newPlot('chartExReasonBar',[{
        y: er.map(r=>r.reason).reverse(),
        x: er.map(r=>r.count).reverse(),
        type:'bar',
        orientation:'h',
        marker:{color:'#60a5fa'},
        text: er.map(r=>r.count+'건').reverse(),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate:'%{y}: %{x}건<extra></extra>',
    }],{...DARK,
        xaxis:{...DARK.xaxis,title:'건수'},
        yaxis:{...DARK.yaxis,automargin:true},
        margin:{l:160,r:50,t:10,b:50},
    },{responsive:true});

    // VC 목록 테이블
    renderVCListTable(SEL.vc_list);
    setupVCFilters();

    // 제외 목록 테이블
    renderExListTable(SEL.excluded_list);
    setupExFilters();

    // 미확인 목록
    renderUnkTable(SEL.unknown_list);

    // 카운트 표시
    document.getElementById('vcListCount').textContent = ss.vc_count;
    document.getElementById('exListCount').textContent = ss.excluded_count;
    document.getElementById('unkListCount').textContent = ss.unknown_count;
}

function renderVCListTable(list){
    if(!list.length){document.getElementById('vcListTable').innerHTML='<p style="color:#888">결과 없음</p>';document.getElementById('vcFilterCount').textContent='';return;}
    const phaseColors={'1A':'#3b82f6','1B':'#3b82f6','1C':'#3b82f6','1D':'#3b82f6','1E':'#60a5fa','1F':'#60a5fa','2':'#22c55e','5_auto':'#f59e0b','5':'#a78bfa'};
    let h='<table class="ranking"><thead><tr><th>#</th><th>SPC_NM (주주명)</th><th>유형</th><th>GP명</th><th>Phase</th><th>확인소스</th><th>비고</th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        const pc=phaseColors[r.phase]||'#888';
        h+=`<tr>
            <td>${i+1}</td>
            <td><b>${r.name}</b></td>
            <td>${r.type==='GP(운용사)'?'<span style="color:#f59e0b">GP</span>':'<span style="color:#60a5fa">펀드</span>'}</td>
            <td style="color:#aaa;font-size:12px">${r.gp||'-'}</td>
            <td><span style="display:inline-block;padding:1px 6px;border-radius:3px;font-size:11px;font-weight:600;background:${pc}22;color:${pc}">${r.phase}</span></td>
            <td style="color:#888;font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.source}">${r.source||'-'}</td>
            <td style="color:#888;font-size:11px;max-width:240px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.note}">${r.note||''}</td>
        </tr>`;
    });
    h+='</tbody></table>';
    document.getElementById('vcListTable').innerHTML=h;
    document.getElementById('vcFilterCount').textContent=list.length+'사 표시';
}

function setupVCFilters(){
    const phases=[...new Set(SEL.vc_list.map(r=>r.phase))].sort();
    const sel=document.getElementById('vcPhaseFilter');
    phases.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent='Phase '+p;sel.appendChild(o);});

    const doFilter=()=>{
        const q=document.getElementById('vcSearchInput').value.toLowerCase();
        const pf=document.getElementById('vcPhaseFilter').value;
        const tf=document.getElementById('vcTypeFilter').value;
        const filtered=SEL.vc_list.filter(r=>{
            if(pf && r.phase!==pf)return false;
            if(tf && r.type!==tf)return false;
            if(q && !(r.name.toLowerCase().includes(q)||r.gp.toLowerCase().includes(q)||(r.source||'').toLowerCase().includes(q)||r.phase.toLowerCase().includes(q)))return false;
            return true;
        });
        renderVCListTable(filtered);
    };

    document.getElementById('vcSearchInput').addEventListener('input',doFilter);
    document.getElementById('vcPhaseFilter').addEventListener('change',doFilter);
    document.getElementById('vcTypeFilter').addEventListener('change',doFilter);
}

function renderExListTable(list){
    if(!list.length){document.getElementById('exListTable').innerHTML='<p style="color:#888">결과 없음</p>';document.getElementById('exFilterCount').textContent='';return;}
    let h='<table class="ranking"><thead><tr><th>#</th><th>SPC_NM (주주명)</th><th>제외사유</th><th>원래Phase</th><th>비고</th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        h+=`<tr>
            <td>${i+1}</td>
            <td>${r.name}</td>
            <td><span class="tag-exclude">${r.reason}</span></td>
            <td style="color:#888;font-size:12px">${r.orig_phase||'-'}</td>
            <td style="color:#888;font-size:11px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${r.note}">${r.note||''}</td>
        </tr>`;
    });
    h+='</tbody></table>';
    document.getElementById('exListTable').innerHTML=h;
    document.getElementById('exFilterCount').textContent=list.length+'사 표시';
}

function setupExFilters(){
    const reasons=[...new Set(SEL.excluded_list.map(r=>r.reason))].sort();
    const sel=document.getElementById('exReasonFilter');
    reasons.forEach(r=>{const o=document.createElement('option');o.value=r;o.textContent=r;sel.appendChild(o);});

    const doFilter=()=>{
        const q=document.getElementById('exSearchInput').value.toLowerCase();
        const rf=document.getElementById('exReasonFilter').value;
        const filtered=SEL.excluded_list.filter(r=>{
            if(rf && r.reason!==rf)return false;
            if(q && !(r.name.toLowerCase().includes(q)||(r.reason||'').toLowerCase().includes(q)||(r.note||'').toLowerCase().includes(q)))return false;
            return true;
        });
        renderExListTable(filtered);
    };

    document.getElementById('exSearchInput').addEventListener('input',doFilter);
    document.getElementById('exReasonFilter').addEventListener('change',doFilter);
}

function renderUnkTable(list){
    if(!list.length){document.getElementById('unkListTable').innerHTML='<p style="color:#888">없음</p>';return;}
    let h='<table class="ranking"><thead><tr><th>#</th><th>SPC_NM</th><th>사업자번호</th><th>비고</th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        h+=`<tr><td>${i+1}</td><td>${r.name}</td><td style="color:#888;font-size:12px">${r.bizno}</td><td style="color:#888;font-size:12px">${r.note}</td></tr>`;
    });
    h+='</tbody></table>';
    document.getElementById('unkListTable').innerHTML=h;
}

/* ── 탭: 조기매도 ── */
let earlyRendered = false;
function renderEarlySell(){
    if(earlyRendered) return;
    earlyRendered = true;
    const list = DATA.early_sell_top30;
    if(!list || !list.length){ document.getElementById('tableEarlySell').innerHTML='<p style="color:#888">데이터 없음</p>'; return; }
    const maxAmt = Math.max(...list.map(r=>Math.abs(r.net_amount)));

    let h='<table class="ranking"><thead><tr><th>#</th><th>종목명</th><th>순매매금액</th><th>공모금액대비</th><th>공모가기준 시총대비</th><th>매도금액</th><th>매수금액</th><th>건수</th><th></th></tr></thead><tbody>';
    list.forEach((r,i)=>{
        const pct = maxAmt>0 ? (Math.abs(r.net_amount)/maxAmt*100) : 0;
        const color = r.net_amount>=0 ? '#ef4444' : '#3b82f6';
        h+=`<tr class="early-row" data-idx="${i}" style="cursor:pointer">
            <td>${i+1}</td>
            <td><b>${r.corp_name}</b></td>
            <td style="color:${color};font-weight:600">${fmtAmt(r.net_amount)}원</td>
            <td style="color:#f59e0b;font-size:12px">${r.pct_offering!=null?r.pct_offering.toFixed(1)+'%':'-'}</td>
            <td style="color:#a78bfa;font-size:12px">${r.pct_mcap!=null?r.pct_mcap.toFixed(1)+'%':'-'}</td>
            <td style="color:#3b82f6">${fmtAmt(r.sell_amount)}원</td>
            <td style="color:#ef4444">${fmtAmt(r.buy_amount)}원</td>
            <td>${r.tx_count}</td>
            <td style="width:16%"><div class="bar-cell"><div class="bar-fill" style="width:${pct}%;background:${color}"></div></div></td>
        </tr>
        <tr class="early-detail" id="early-detail-${i}" style="display:none">
            <td colspan="9" style="padding:0">
                <div style="background:#14161e;padding:12px 16px;border:1px solid #2a2d3a;border-radius:6px;margin:4px 10px 8px">
                    <div style="font-size:11px;color:#888;margin-bottom:6px">공시내역 (${r.disclosures.length}건) — 클릭하면 DART 공시 페이지로 이동</div>
                    <table class="ranking" style="font-size:12px">
                        <thead><tr><th>일자</th><th>경과일</th><th>VC(주주)</th><th>유형</th><th>금액</th><th>수량</th><th>DART 공시</th></tr></thead>
                        <tbody>${r.disclosures.map(d=>{
                            const dartUrl = d.rcept_no ? 'https://dart.fss.or.kr/dsaf001/main.do?rcpNo='+d.rcept_no : '';
                            const dartLink = dartUrl ? '<a href="'+dartUrl+'" target="_blank" rel="noopener" style="color:#60a5fa;text-decoration:none">'+d.rcept_no+'</a>' : '-';
                            const dcolor = d.amount>=0 ? '#ef4444' : '#3b82f6';
                            return `<tr>
                                <td>${d.date}</td>
                                <td>+${d.days}일</td>
                                <td>${d.vc}</td>
                                <td>${d.type}</td>
                                <td style="color:${dcolor}">${fmtAmt(d.amount)}원</td>
                                <td style="color:${dcolor}">${d.shares.toLocaleString()}주</td>
                                <td>${dartLink}</td>
                            </tr>`;
                        }).join('')}</tbody>
                    </table>
                </div>
            </td>
        </tr>`;
    });
    h+='</tbody></table>';
    document.getElementById('tableEarlySell').innerHTML=h;

    // 클릭으로 공시내역 토글
    document.querySelectorAll('.early-row').forEach(row=>{
        row.addEventListener('click',()=>{
            const idx=row.dataset.idx;
            const detail=document.getElementById('early-detail-'+idx);
            detail.style.display=detail.style.display==='none'?'table-row':'none';
        });
    });
}

/* ── 탭: 연도별 비교 ── */
let yearlyRendered = false;
function renderYearlyEarlySell(){
    if(yearlyRendered || !DATA || !DATA.yearly_early_sell) return;
    yearlyRendered = true;

    const ys = DATA.yearly_early_sell.sort((a,b)=>a.year-b.year);
    const yb = DATA.yearly_early_bin || [];
    const years = ys.map(d=>String(d.year));

    const palette = ['#3b82f6','#ef4444','#22c55e','#f59e0b','#a78bfa',
                     '#ec4899','#60a5fa','#f87171','#34d399','#fbbf24',
                     '#818cf8','#fb923c'];

    // ── 요약 테이블 (최상단) ──
    const fB = v => {
        const a=Math.abs(v),s=v<0?'-':'';
        if(a>=1e12) return s+(a/1e12).toFixed(1)+'조';
        if(a>=1e8) return s+(a/1e8).toFixed(0)+'억';
        if(a>=1e4) return s+Math.round(a/1e4)+'만';
        return v.toLocaleString()+'원';
    };
    const amtColor = v => v<0?'#60a5fa':'#f87171';
    const pctBar = v => {
        const w = Math.min(Math.abs(v), 120);
        const c = v<0?'rgba(96,165,250,0.25)':'rgba(248,113,113,0.25)';
        return `background:linear-gradient(90deg,${c} ${w}%,transparent ${w}%)`;
    };

    let h = `<table style="width:100%;border-collapse:separate;border-spacing:0;font-size:13px;">
    <thead><tr style="background:#1a1d29;">
        <th style="padding:10px 12px;text-align:center;border-bottom:2px solid #3b82f6;white-space:nowrap;" rowspan="2">상장연도</th>
        <th style="padding:10px 12px;text-align:center;border-bottom:2px solid #3b82f6;white-space:nowrap;" rowspan="2">전체 IPO</th>
        <th style="padding:10px 12px;text-align:center;border-bottom:2px solid #3b82f6;white-space:nowrap;" rowspan="2">VC보유 IPO</th>
        <th style="padding:10px 12px;text-align:center;border-bottom:2px solid #3b82f6;white-space:nowrap;" rowspan="2">공모금액</th>
        <th style="padding:10px 6px;text-align:center;border-bottom:2px solid #f59e0b;border-left:2px solid #2a2d3a;" colspan="2">전체 (24개월)</th>
        <th style="padding:10px 6px;text-align:center;border-bottom:2px solid #ec4899;border-left:2px solid #2a2d3a;" colspan="2">6개월 이내</th>
    </tr><tr style="background:#1a1d29;">
        <th style="padding:6px 12px;text-align:center;border-bottom:1px solid #2a2d3a;border-left:2px solid #2a2d3a;color:#f59e0b;font-size:11px;">순매도액</th>
        <th style="padding:6px 12px;text-align:center;border-bottom:1px solid #2a2d3a;color:#f59e0b;font-size:11px;">공모금액 대비</th>
        <th style="padding:6px 12px;text-align:center;border-bottom:1px solid #2a2d3a;border-left:2px solid #2a2d3a;color:#ec4899;font-size:11px;">순매도액</th>
        <th style="padding:6px 12px;text-align:center;border-bottom:1px solid #2a2d3a;color:#ec4899;font-size:11px;">공모금액 대비</th>
    </tr></thead><tbody>`;

    ys.forEach((d,i)=>{
        const bg = i%2===0 ? 'background:#12141c;' : 'background:#161820;';
        const offering = d.total_ipo_offering;
        h+=`<tr style="${bg}">
            <td style="padding:9px 12px;text-align:center;font-weight:bold;color:#e0e0e0;">${d.year}</td>
            <td style="padding:9px 12px;text-align:center;color:#aaa;">${d.ipo_total_count}</td>
            <td style="padding:9px 12px;text-align:center;color:#aaa;">${d.vc_ipo_count}</td>
            <td style="padding:9px 12px;text-align:right;color:#ccc;">${fB(offering)}</td>
            <td style="padding:9px 12px;text-align:right;color:${amtColor(d.full_net_amount)};border-left:2px solid #2a2d3a;">${fB(d.full_net_amount)}</td>
            <td style="padding:9px 12px;text-align:right;color:${amtColor(d.full_pct_offering)};${pctBar(d.full_pct_offering)}">${d.full_pct_offering.toFixed(1)}%</td>
            <td style="padding:9px 12px;text-align:right;color:${amtColor(d.net_amount)};border-left:2px solid #2a2d3a;">${fB(d.net_amount)}</td>
            <td style="padding:9px 12px;text-align:right;color:${amtColor(d.pct_offering)};${pctBar(d.pct_offering)}">${d.pct_offering.toFixed(1)}%</td>
        </tr>`;
    });

    // 합계
    const totIpo=ys.reduce((s,d)=>s+d.ipo_total_count,0);
    const totVcIpo=ys.reduce((s,d)=>s+d.vc_ipo_count,0);
    const totOffering=ys.reduce((s,d)=>s+d.total_ipo_offering,0);
    const totFullNet=ys.reduce((s,d)=>s+d.full_net_amount,0);
    const totFullPct=totOffering?totFullNet/totOffering*100:0;
    const totNet=ys.reduce((s,d)=>s+d.net_amount,0);
    const totPct=totOffering?totNet/totOffering*100:0;
    h+=`<tr style="background:#1a1d29;font-weight:bold;border-top:2px solid #3a3d4a;">
        <td style="padding:10px 12px;text-align:center;">합계</td>
        <td style="padding:10px 12px;text-align:center;">${totIpo}</td>
        <td style="padding:10px 12px;text-align:center;">${totVcIpo}</td>
        <td style="padding:10px 12px;text-align:right;">${fB(totOffering)}</td>
        <td style="padding:10px 12px;text-align:right;color:${amtColor(totFullNet)};border-left:2px solid #2a2d3a;">${fB(totFullNet)}</td>
        <td style="padding:10px 12px;text-align:right;color:${amtColor(totFullPct)};">${totFullPct.toFixed(1)}%</td>
        <td style="padding:10px 12px;text-align:right;color:${amtColor(totNet)};border-left:2px solid #2a2d3a;">${fB(totNet)}</td>
        <td style="padding:10px 12px;text-align:right;color:${amtColor(totPct)};">${totPct.toFixed(1)}%</td>
    </tr>`;
    h+='</tbody></table>';
    document.getElementById('tableYearlySummary').innerHTML=h;

    // ── 차트: 전체(24개월) 순매도금액 bar (주황 계열) ──
    const fullAmounts = ys.map(d=>d.full_net_amount);
    Plotly.newPlot('chartYearlyFullBar',[{
        x: years,
        y: fullAmounts,
        type:'bar',
        marker:{color:'#f59e0b'},
        text: fullAmounts.map(v=>fmtAmt(v)),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate:'%{x}년<br>24개월 순매도: %{customdata}<extra></extra>',
        customdata: fullAmounts.map(v=>fmtAmt(v)),
    }],{
        ...DARK,
        xaxis:{...DARK.xaxis, title:'상장연도', type:'category'},
        yaxis: krwYAxis(fullAmounts,'순매도금액'),
        margin:{...DARK.margin, t:30},
    },{responsive:true});

    // ── 차트: 전체(24개월) 공모금액 대비 비율 bar (초록 계열) ──
    const fullPctValues = ys.map(d=>d.full_pct_offering);
    Plotly.newPlot('chartYearlyFullPct',[{
        x: years,
        y: fullPctValues,
        type:'bar',
        marker:{color:'#22c55e'},
        text: fullPctValues.map(v=>v.toFixed(1)+'%'),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate:'%{x}년<br>공모금액 대비: %{y:.1f}%<extra></extra>',
    }],{
        ...DARK,
        xaxis:{...DARK.xaxis, title:'상장연도', type:'category'},
        yaxis:{...DARK.yaxis, title:'공모금액 대비 (%)', ticksuffix:'%'},
        margin:{...DARK.margin, t:30},
    },{responsive:true});

    // ── 차트: 6개월 이내 순매도금액 bar (파랑 계열) ──
    const netAmounts = ys.map(d=>d.net_amount);
    Plotly.newPlot('chartYearlyBar',[{
        x: years,
        y: netAmounts,
        type:'bar',
        marker:{color:'#3b82f6'},
        text: netAmounts.map(v=>fmtAmt(v)),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate:'%{x}년<br>6개월 이내 순매도: %{customdata}<extra></extra>',
        customdata: netAmounts.map(v=>fmtAmt(v)),
    }],{
        ...DARK,
        xaxis:{...DARK.xaxis, title:'상장연도', type:'category'},
        yaxis: krwYAxis(netAmounts,'순매도금액'),
        margin:{...DARK.margin, t:30},
    },{responsive:true});

    // ── 차트 2: 공모금액 대비 비율 bar (분홍 계열) ──
    const pctValues = ys.map(d=>d.pct_offering);
    Plotly.newPlot('chartYearlyPct',[{
        x: years,
        y: pctValues,
        type:'bar',
        marker:{color:'#ec4899'},
        text: pctValues.map(v=>v.toFixed(1)+'%'),
        textposition:'outside',
        textfont:{color:'#aaa',size:11},
        hovertemplate:'%{x}년<br>공모금액 대비: %{y:.1f}%<extra></extra>',
    }],{
        ...DARK,
        xaxis:{...DARK.xaxis, title:'상장연도', type:'category'},
        yaxis:{...DARK.yaxis, title:'공모금액 대비 (%)', ticksuffix:'%'},
        margin:{...DARK.margin, t:30},
    },{responsive:true});

    // ── 차트 3: 연도×30일빈 line chart ──
    const binDays = [0,30,60,90,120,150,180];
    const binLabels = binDays.map(d=>d+'일');
    const lineTraces = years.map((yr,i)=>{
        const yrData = yb.filter(d=>String(d.year)===yr);
        const yVals = binDays.map(day=>{
            const found = yrData.find(d=>d.days===day);
            return found ? found.net_amount : 0;
        });
        return {
            x: binLabels,
            y: yVals,
            type:'scatter',
            mode:'lines+markers',
            name:yr+'년',
            line:{color:palette[i%palette.length], width:2},
            marker:{size:6},
            hovertemplate:yr+'년 %{x}<br>%{customdata}<extra></extra>',
            customdata: yVals.map(v=>fmtAmt(v)),
        };
    });
    Plotly.newPlot('chartYearlyBin', lineTraces, {
        ...DARK,
        xaxis:{...DARK.xaxis, title:'상장 후 경과일'},
        yaxis: krwYAxis(yb.map(d=>d.net_amount),'순매도금액'),
        margin:{...DARK.margin, t:30},
        legend:{font:{color:'#ccc'},bgcolor:'rgba(0,0,0,0)'},
    },{responsive:true});
}

/* ── Tabs ── */
function initTabs(){
    document.querySelectorAll('.tab').forEach(el=>{
        el.addEventListener('click',()=>{
            const tab=el.dataset.tab;
            document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t.dataset.tab===tab));
            ['net','type','corp','vc','early','yearly','criteria','notes'].forEach(t=>{
                const p=document.getElementById('tab-'+t);
                if(p) p.style.display=t===tab?'block':'none';
            });
            if(tab==='type') setTimeout(()=>{renderTypeBar();renderTypeTime();},80);
            if(tab==='corp') setTimeout(renderCorpRanking,80);
            if(tab==='vc') setTimeout(renderVCRanking,80);
            if(tab==='early') setTimeout(renderEarlySell,80);
            if(tab==='yearly') setTimeout(renderYearlyEarlySell,80);
            if(tab==='criteria') setTimeout(renderCriteria,80);
            if(tab==='notes') setTimeout(renderNotes,80);
        });
    });
}

/* ── 탭: 참고사항 (비보통주 상세) ── */
let notesRendered = false;
function renderNotes(){
    if(notesRendered || !DATA || !DATA.non_common_stocks) return;
    notesRendered = true;
    const ncs = DATA.non_common_stocks;

    // 통계
    const totalRecs = ncs.reduce((s,c)=>s+c.records.length, 0);
    let dualCount = 0, onlyCount = 0;
    ncs.forEach(c=>{
        c.records.forEach(r=>{
            if(r.has_common) dualCount++;
            else onlyCount++;
        });
    });
    document.getElementById('ncTotalRecords').textContent = totalRecs;
    document.getElementById('ncTotalCorps').textContent = ncs.length;
    document.getElementById('ncDualCount').textContent = dualCount;
    document.getElementById('ncOnlyCount').textContent = onlyCount;

    // 주식종류별 분포 차트
    const typeDist = {};
    ncs.forEach(c=>c.records.forEach(r=>{
        typeDist[r.stk_knd] = (typeDist[r.stk_knd]||0)+1;
    }));
    const types = Object.entries(typeDist).sort((a,b)=>b[1]-a[1]);
    const typeColors = {
        '전환사채권':'#f59e0b',
        '신주인수권부사채권':'#3b82f6',
        '의결권있는 주식으로 전환될주식':'#22c55e',
        '증권예탁증권':'#a78bfa',
        '신주인수권이표시된것':'#ec4899'
    };
    Plotly.newPlot('chartNcTypeDist',[{
        x: types.map(t=>t[0]),
        y: types.map(t=>t[1]),
        type:'bar',
        marker:{color:types.map(t=>typeColors[t[0]]||'#888')},
        text: types.map(t=>t[1]+'건'),
        textposition:'outside',
        textfont:{color:'#aaa',size:12},
        hovertemplate:'%{x}: %{y}건<extra></extra>'
    }],{...DARK,
        xaxis:{...DARK.xaxis},
        yaxis:{...DARK.yaxis,title:'건수'},
        margin:{l:50,r:30,t:10,b:100},
    },{responsive:true});

    // 종목별 상세 아코디언
    const STK_KND_LABELS = {
        '전환사채권':'CB (전환사채)',
        '신주인수권부사채권':'BW (신주인수권부사채)',
        '의결권있는 주식으로 전환될주식':'전환될 주식',
        '증권예탁증권':'DR (예탁증권)',
        '신주인수권이표시된것':'신주인수권증서'
    };
    const STK_KND_COLORS = {
        '전환사채권':'#f59e0b',
        '신주인수권부사채권':'#3b82f6',
        '의결권있는 주식으로 전환될주식':'#22c55e',
        '증권예탁증권':'#a78bfa',
        '신주인수권이표시된것':'#ec4899'
    };

    function cleanPrice(s){
        if(!s || s==='-' || s==='(-)')return '-';
        return s.replace(/&cr;/g,' ').replace(/\s+/g,' ').trim();
    }
    function cleanRmk(s){
        if(!s || s==='-')return '';
        return s.replace(/&cr;/g,' ').replace(/\s+/g,' ').trim();
    }

    let html = '';
    ncs.forEach((corp, ci) => {
        const recs = corp.records;
        const stkTypes = [...new Set(recs.map(r=>r.stk_knd))];
        const tags = stkTypes.map(t=>{
            const c = STK_KND_COLORS[t]||'#888';
            const l = STK_KND_LABELS[t]||t;
            return '<span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:'+c+'22;color:'+c+';margin-right:4px">'+l+'</span>';
        }).join('');

        const totalQty = recs.reduce((s,r)=>{
            const n = parseInt((r.mdf_sdk_cnt||'0').replace(/,/g,''),10);
            return s + (isNaN(n)?0:n);
        },0);

        html += '<div style="border:1px solid #2a2d3a;border-radius:8px;margin-bottom:8px;overflow:hidden">';
        html += '<div class="nc-corp-header" data-idx="'+ci+'" style="display:flex;align-items:center;gap:12px;padding:12px 16px;cursor:pointer;background:#14161e;transition:background .15s">';
        html += '<span style="color:#888;font-size:12px;min-width:24px">'+(ci+1)+'</span>';
        html += '<b style="font-size:14px;color:#fff;min-width:120px">'+corp.corp_name+'</b>';
        html += '<span style="color:#888;font-size:12px">('+corp.stock_code+')</span>';
        html += tags;
        html += '<span style="margin-left:auto;color:#888;font-size:12px">'+recs.length+'건 | '+totalQty.toLocaleString()+'주</span>';
        html += '<span style="color:#3a3d4a;font-size:14px" id="nc-arrow-'+ci+'">&#9654;</span>';
        html += '</div>';

        html += '<div id="nc-detail-'+ci+'" style="display:none;padding:0 16px 16px;background:#1a1d29">';

        recs.forEach((r, ri)=>{
            const stkColor = STK_KND_COLORS[r.stk_knd]||'#888';
            const stkLabel = STK_KND_LABELS[r.stk_knd]||r.stk_knd;
            const dartUrl = r.rcept_no_new ? 'https://dart.fss.or.kr/dsaf001/main.do?rcpNo='+r.rcept_no_new : '';
            const rmk = cleanRmk(r.rmk);
            const price = cleanPrice(r.hld_unt_pr);

            html += '<div style="border:1px solid #2a2d3a;border-radius:6px;padding:14px 16px;margin-top:10px;background:#14161e">';

            // 헤더: VC명 + 주식종류
            html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">';
            html += '<span style="font-weight:600;font-size:13px;color:#e0e0e0">'+r.spc_nm+'</span>';
            html += '<span style="padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600;background:'+stkColor+'22;color:'+stkColor+'">'+stkLabel+'</span>';
            if(r.has_common) html += '<span style="padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;background:rgba(34,197,94,0.15);color:#22c55e">보통주 동시보유</span>';
            html += '</div>';

            // 상세 테이블
            html += '<table style="width:100%;border-collapse:collapse;font-size:13px">';
            html += '<tbody>';

            html += '<tr><td style="padding:4px 10px;color:#888;width:140px;border-bottom:1px solid #1f2230">변동일자</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230">'+r.mdf_dt+'</td></tr>';

            html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">보유방법</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230">'+r.hld_mth_adj+'</td></tr>';

            html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">변동수량</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230;font-weight:600;color:#fff">'+r.mdf_sdk_cnt+'주</td></tr>';

            html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">보유단가</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230;'+(price!=='-'?'color:#f59e0b;font-weight:600':'color:#666')+'">'+(price!=='-'?price+'원':price)+'</td></tr>';

            html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">변동전 수량</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230">'+(r.bfr_mdf_cnt||'-')+'주</td></tr>';

            html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">변동후 수량</td>';
            html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230">'+r.afr_mdf_cnt+'주</td></tr>';

            if(rmk){
                html += '<tr><td style="padding:4px 10px;color:#888;border-bottom:1px solid #1f2230">비고(RMK)</td>';
                html += '<td style="padding:4px 10px;border-bottom:1px solid #1f2230;color:#93c5fd;font-style:italic">'+rmk+'</td></tr>';
            }

            html += '<tr><td style="padding:4px 10px;color:#888">DART 공시</td>';
            if(dartUrl){
                html += '<td style="padding:4px 10px"><a href="'+dartUrl+'" target="_blank" rel="noopener" style="color:#60a5fa;text-decoration:none">'+r.rcept_no_new+' &#8599;</a></td></tr>';
            } else {
                html += '<td style="padding:4px 10px;color:#666">-</td></tr>';
            }

            html += '</tbody></table>';

            // 보통주 동시보유 정보
            if(r.has_common && r.common_info){
                html += '<div style="margin-top:8px;padding:8px 12px;background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2);border-radius:4px;font-size:12px">';
                html += '<span style="color:#22c55e;font-weight:600">동시 보유 보통주:</span> ';
                html += '<span style="color:#d0d0d0">'+r.common_info.qty+'주</span>';
                if(r.common_info.unit_price && r.common_info.unit_price !== '-'){
                    html += ' <span style="color:#888">|</span> <span style="color:#f59e0b">단가 '+r.common_info.unit_price+'원</span>';
                }
                html += '</div>';
            }

            html += '</div>';
        });

        html += '</div>';
        html += '</div>';
    });

    document.getElementById('ncCorpList').innerHTML = html;

    // 아코디언 토글
    document.querySelectorAll('.nc-corp-header').forEach(el=>{
        el.addEventListener('click',()=>{
            const idx = el.dataset.idx;
            const detail = document.getElementById('nc-detail-'+idx);
            const arrow = document.getElementById('nc-arrow-'+idx);
            if(detail.style.display==='none'){
                detail.style.display='block';
                arrow.innerHTML='&#9660;';
                el.style.background='#1a1d29';
            } else {
                detail.style.display='none';
                arrow.innerHTML='&#9654;';
                el.style.background='#14161e';
            }
        });
        el.addEventListener('mouseenter',()=>{ el.style.background='#1f2233'; });
        el.addEventListener('mouseleave',()=>{
            const idx = el.dataset.idx;
            const detail = document.getElementById('nc-detail-'+idx);
            el.style.background = detail.style.display==='none' ? '#14161e' : '#1a1d29';
        });
    });
}
</script>
</body>
</html>
